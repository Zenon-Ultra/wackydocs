
{% extends "base.html" %}

{% block title %}PDF 자료실 - 한국 학습 플랫폼{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12 mb-4">
            <h2><i class="fas fa-file-pdf me-2"></i>PDF 자료실</h2>
            <p class="text-muted">원하는 학습 자료를 요청하고 다운로드하세요.</p>
        </div>
    </div>

    <!-- PDF Request Form -->
    <div class="row mb-5">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus me-2"></i>자료 요청하기
                    </h5>
                </div>
                <div class="card-body">
                    {% if not can_request_today %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>오늘의 요청 완료</strong><br>
                            하루에 한 번만 PDF 자료를 요청할 수 있습니다. 내일 다시 시도해주세요.
                            <br><small class="text-muted">오늘 요청 수: {{ today_request_count }}회</small>
                        </div>
                    {% endif %}

                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.subject.label(class="form-label") }}
                            {{ form.subject(class="form-select", disabled=not can_request_today) }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.topic.label(class="form-label") }}
                            {{ form.topic(class="form-control", placeholder="예: 미적분 극한의 성질", disabled=not can_request_today) }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="3", placeholder="필요한 자료에 대한 상세한 설명을 작성해주세요.", disabled=not can_request_today) }}
                        </div>
                        
                        {% if can_request_today %}
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>하루에 한 번만 요청할 수 있습니다. 신중하게 작성해주세요.</small>
                            </div>
                        {% endif %}
                        
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary", disabled=not can_request_today) }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>내 요청 내역
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_requests %}
                        <div class="list-group list-group-flush">
                            {% for request in user_requests %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ request.subject }} - {{ request.topic }}</h6>
                                        <p class="mb-1 small text-muted">{{ request.description[:50] }}{% if request.description|length > 50 %}...{% endif %}</p>
                                        <small class="text-muted">{{ request.requested_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if request.status == 'approved' else 'warning' if request.status == 'pending' else 'danger' }}">
                                        {{ '승인됨' if request.status == 'approved' else '대기중' if request.status == 'pending' else '거절됨' }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            아직 요청한 자료가 없습니다.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-end g-3">
                        <div class="col-md-4">
                            <label class="form-label">검색</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="제목, 과목으로 검색...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">과목 필터</label>
                            <select id="subjectFilter" class="form-select">
                                <option value="">전체 과목</option>
                                <option value="국어">국어</option>
                                <option value="영어">영어</option>
                                <option value="수학">수학</option>
                                <option value="과학">과학</option>
                                <option value="사회">사회</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">카테고리 필터</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">전체 카테고리</option>
                                <option value="suneung">수능</option>
                                <option value="naeshin">내신</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Resources -->
    <div class="row">
        <div class="col-12 mb-3">
            <h4>이용 가능한 자료 <span id="resourceCount" class="badge bg-secondary">{{ all_resources|length }}개</span></h4>
        </div>
    </div>

    <!-- Unified Resources -->
    <div class="row" id="resourcesContainer">
        {% if all_resources %}
            {% for resource in all_resources %}
            <div class="col-md-6 col-lg-4 mb-3 resource-item" 
                 data-subject="{{ resource.subject }}" 
                 data-category="{{ resource.category }}" 
                 data-title="{{ resource.title }}">
                <div class="card border-{{ 'success' if resource.category == 'suneung' else 'warning' }}">
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-2">
                            <i class="fas fa-file-pdf text-danger fa-2x me-2"></i>
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">{{ resource.title }}</h6>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    <span class="badge bg-{{ 'success' if resource.category == 'suneung' else 'warning' }}">
                                        {{ '수능' if resource.category == 'suneung' else '내신' }}
                                    </span>
                                    <span class="badge bg-secondary">{{ resource.subject }}</span>
                                </div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ resource.upload_date.strftime('%Y-%m-%d') }}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-download me-1"></i>{{ resource.download_count }}회 다운로드
                            </small>
                            <a href="{{ url_for('download_pdf', resource_id=resource.id) }}" class="btn btn-{{ 'success' if resource.category == 'suneung' else 'warning' }} btn-sm">
                                <i class="fas fa-download me-1"></i>다운로드
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <p class="text-muted text-center py-4">
                    <i class="fas fa-folder-open fa-2x mb-2 d-block"></i>
                    아직 이용 가능한 자료가 없습니다.
                </p>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const subjectFilter = document.getElementById('subjectFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const resourceItems = document.querySelectorAll('.resource-item');
    const resourceCount = document.getElementById('resourceCount');

    function filterResources() {
        const searchTerm = searchInput.value.toLowerCase();
        const subjectValue = subjectFilter.value;
        const categoryValue = categoryFilter.value;
        let visibleCount = 0;

        resourceItems.forEach(item => {
            const title = item.dataset.title.toLowerCase();
            const subject = item.dataset.subject;
            const category = item.dataset.category;

            const matchesSearch = title.includes(searchTerm);
            const matchesSubject = !subjectValue || subject === subjectValue;
            const matchesCategory = !categoryValue || category === categoryValue;

            if (matchesSearch && matchesSubject && matchesCategory) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        resourceCount.textContent = visibleCount + '개';
    }

    searchInput.addEventListener('input', filterResources);
    subjectFilter.addEventListener('change', filterResources);
    categoryFilter.addEventListener('change', filterResources);
});

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('subjectFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    
    const resourceItems = document.querySelectorAll('.resource-item');
    resourceItems.forEach(item => {
        item.style.display = 'block';
    });
    
    document.getElementById('resourceCount').textContent = resourceItems.length + '개';
}
</script>
{% endblock %}
