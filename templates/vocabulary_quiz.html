{% extends "base.html" %}

{% block title %}ì–´íœ˜ í€´ì¦ˆ - í•œêµ­ í•™ìŠµ í”Œë«í¼{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Quiz Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-brain me-2"></i>
                        {{ 'êµ­ì–´ ê³ ì „ì–´íœ˜' if quiz_type == 'korean' else 'ì˜ì–´ ë‹¨ì–´' }} í€´ì¦ˆ
                    </h3>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-4">
                            <h5 class="text-primary" id="currentQuestion">1</h5>
                            <small class="text-muted">í˜„ì¬ ë¬¸ì œ</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-success" id="correctCount">0</h5>
                            <small class="text-muted">ë§íŒ ë¬¸ì œ</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info" id="totalQuestions">{{ words|length }}</h5>
                            <small class="text-muted">ì „ì²´ ë¬¸ì œ</small>
                        </div>
                    </div>

                    <div class="progress mt-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>
            </div>

            <!-- Quiz Card -->
            <div class="card quiz-card" id="quizCard">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <h2 class="text-primary" id="questionWord">ë¡œë”© ì¤‘...</h2>
                        <p class="text-muted">ìœ„ ë‹¨ì–´ì˜ ëœ»ì€ ë¬´ì—‡ì¸ê°€ìš”?</p>
                    </div>

                    <div class="row g-3" id="optionsContainer">
                        <!-- Options will be generated by JavaScript -->
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-outline-secondary" onclick="skipQuestion()">
                            <i class="fas fa-forward me-2"></i>ê±´ë„ˆë›°ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- Result Card (Hidden) -->
            <div class="card d-none" id="resultCard">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>í€´ì¦ˆ ì™„ë£Œ!
                    </h3>
                </div>
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <h1 class="display-4 text-success" id="finalScore">0%</h1>
                        <p class="lead" id="scoreMessage">í›Œë¥­í•©ë‹ˆë‹¤!</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-4">
                            <h4 class="text-success" id="finalCorrect">0</h4>
                            <small class="text-muted">ë§íŒ ë¬¸ì œ</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-danger" id="finalWrong">0</h4>
                            <small class="text-muted">í‹€ë¦° ë¬¸ì œ</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning" id="finalSkipped">0</h4>
                            <small class="text-muted">ê±´ë„ˆë›´ ë¬¸ì œ</small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-success" onclick="restartQuiz()">
                            <i class="fas fa-redo me-2"></i>ë‹¤ì‹œ í’€ê¸°
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                            <i class="fas fa-home me-2"></i>ëŒ€ì‹œë³´ë“œë¡œ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let quizData = {{ words|tojson|safe }};
let currentQuestionIndex = 0;
let correctAnswers = 0;
let wrongAnswers = 0;
let skippedAnswers = 0;
let currentQuestion = null;
let isAnswered = false;

// Shuffle array function
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Generate quiz question
function generateQuestion() {
    if (currentQuestionIndex >= quizData.length) {
        showResults();
        return;
    }

    currentQuestion = quizData[currentQuestionIndex];
    isAnswered = false;

    // Update progress
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    const progress = ((currentQuestionIndex) / quizData.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';

    // Set question word
    document.getElementById('questionWord').textContent = currentQuestion.word;

    // Generate options
    generateOptions();
}

function generateOptions() {
    const correctAnswer = currentQuestion.meaning;
    const wrongAnswers = [];

    // Get wrong answers from other words (ensure no duplicates)
    const allWords = quizData.filter(w => w.word !== currentQuestion.word && w.meaning !== correctAnswer);
    if (allWords.length > 0) {
        const shuffledWords = shuffleArray(allWords);
        // Take up to 2 unique meanings
        for (let word of shuffledWords) {
            if (!wrongAnswers.includes(word.meaning) && word.meaning !== correctAnswer) {
                wrongAnswers.push(word.meaning);
                if (wrongAnswers.length >= 2) break;
            }
        }
    }

    // If we still don't have enough wrong answers, add some default ones
    while (wrongAnswers.length < 2) {
        const defaultAnswers = ['ë‹¤ë¥¸ ì˜ë¯¸', 'ê´€ë ¨ ì—†ëŠ” ëœ»', 'ë¹„ìŠ·í•œ ë‹¨ì–´', 'ë‹¤ë¥¸ í‘œí˜„'];
        for (let defaultAnswer of defaultAnswers) {
            if (!wrongAnswers.includes(defaultAnswer) && defaultAnswer !== correctAnswer) {
                wrongAnswers.push(defaultAnswer);
                if (wrongAnswers.length >= 2) break;
            }
        }
        break; // Prevent infinite loop
    }

    // Take only first 2 wrong answers
    const finalWrongAnswers = wrongAnswers.slice(0, 2);

    // Combine correct and wrong answers
    const options = shuffleArray([correctAnswer, ...finalWrongAnswers]);

    // Generate HTML
    const container = document.getElementById('optionsContainer');
    container.innerHTML = '';

    options.forEach((option, index) => {
        const isCorrect = option === correctAnswer;
        const button = document.createElement('div');
        button.className = 'col-12';
        button.innerHTML = `
            <button class="btn btn-outline-primary w-100 py-3 option-btn" 
                    onclick="selectAnswer(\`${option}\`, ${isCorrect})" 
                    data-option="${option}">
                ${option}
            </button>
        `;
        container.appendChild(button);
    });
}

// Handle answer selection
function selectAnswer(selectedAnswer, isCorrect) {
    if (isAnswered) return;

    isAnswered = true;

    // Update counters
    if (isCorrect) {
        correctAnswers++;
        document.getElementById('correctCount').textContent = correctAnswers;
    } else {
        wrongAnswers++;
    }

    // Show correct/incorrect feedback
    const buttons = document.querySelectorAll('.option-btn');
    buttons.forEach(btn => {
        const option = btn.dataset.option;
        if (option === currentQuestion.meaning) {
            btn.className = 'btn btn-success w-100 py-3';
            btn.innerHTML = `<i class="fas fa-check me-2"></i>${option}`;
        } else if (option === selectedAnswer && !isCorrect) {
            btn.className = 'btn btn-danger w-100 py-3';
            btn.innerHTML = `<i class="fas fa-times me-2"></i>${option}`;
        } else {
            btn.className = 'btn btn-outline-secondary w-100 py-3';
        }
        btn.disabled = true;
    });

    // Move to next question after delay
    setTimeout(() => {
        nextQuestion();
    }, 1500);
}

// Skip current question
function skipQuestion() {
    if (isAnswered) return;

    skippedAnswers++;
    isAnswered = true;

    // Show correct answer
    const buttons = document.querySelectorAll('.option-btn');
    buttons.forEach(btn => {
        const option = btn.dataset.option;
        if (option === currentQuestion.meaning) {
            btn.className = 'btn btn-warning w-100 py-3';
        } else {
            btn.className = 'btn btn-outline-secondary w-100 py-3';
        }
        btn.disabled = true;
    });

    setTimeout(() => {
        nextQuestion();
    }, 1500);
}

// Move to next question
function nextQuestion() {
    currentQuestionIndex++;
    generateQuestion();
}

// Show quiz results
function showResults() {
    const totalQuestions = quizData.length;
    const percentage = Math.round((correctAnswers / totalQuestions) * 100);

    // Update result display
    document.getElementById('finalScore').textContent = percentage + '%';
    document.getElementById('finalCorrect').textContent = correctAnswers;
    document.getElementById('finalWrong').textContent = wrongAnswers;
    document.getElementById('finalSkipped').textContent = skippedAnswers;

    // Score message
    let message = '';
    if (percentage >= 90) message = 'ì™„ë²½í•©ë‹ˆë‹¤! ğŸ†';
    else if (percentage >= 80) message = 'í›Œë¥­í•©ë‹ˆë‹¤! ğŸ‘';
    else if (percentage >= 70) message = 'ì˜í–ˆìŠµë‹ˆë‹¤! ğŸ‘';
    else if (percentage >= 60) message = 'ì¢‹ìŠµë‹ˆë‹¤! ğŸ“š';
    else message = 'ë” ì—´ì‹¬íˆ ê³µë¶€í•´ë³´ì„¸ìš”! ğŸ’ª';

    document.getElementById('scoreMessage').textContent = message;

    // Hide quiz card and show result card
    document.getElementById('quizCard').classList.add('d-none');
    document.getElementById('resultCard').classList.remove('d-none');

    // Submit score to server
    submitQuizScore(correctAnswers, totalQuestions);
}

// Submit quiz score to server
function submitQuizScore(score, total) {
    fetch('/submit-quiz-score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quiz_type: '{{ quiz_type }}',
            score: score,
            total_questions: total
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Score submitted successfully');
    })
    .catch(error => {
        console.error('Error submitting score:', error);
    });
}

// Restart quiz
function restartQuiz() {
    currentQuestionIndex = 0;
    correctAnswers = 0;
    wrongAnswers = 0;
    skippedAnswers = 0;

    // Update displays
    document.getElementById('correctCount').textContent = '0';
    document.getElementById('progressBar').style.width = '0%';

    // Show quiz card and hide result card
    document.getElementById('quizCard').classList.remove('d-none');
    document.getElementById('resultCard').classList.add('d-none');

    // Shuffle questions for variety
    quizData = shuffleArray(quizData);

    // Start quiz
    generateQuestion();
}

// Initialize quiz when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (quizData.length === 0) {
        document.getElementById('questionWord').textContent = 'í€´ì¦ˆí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤';
        document.getElementById('optionsContainer').innerHTML = 
            '<div class="col-12"><p class="text-muted">ë‹¨ì–´ë¥¼ ì¶”ê°€í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p></div>';
        return;
    }

    // Shuffle questions
    quizData = shuffleArray(quizData);
    generateQuestion();
});
</script>
{% endblock %}