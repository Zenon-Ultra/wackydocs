{% extends "base.html" %}

{% block title %}문의 상세보기 - WackyDocs{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-ticket-alt me-2"></i>{{ ticket.subject }}</h2>
                    <p class="text-muted mb-0">문의번호: #{{ ticket.id }} | 작성자: {{ ticket.user.username }}</p>
                </div>
                <div>
                    {% if ticket.status == 'open' %}
                        <span class="badge bg-primary fs-6">대기중</span>
                    {% elif ticket.status == 'answered' %}
                        <span class="badge bg-success fs-6">답변완료</span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">종료</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 원본 문의 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-user me-2"></i>{{ ticket.user.username }}
                            {% if ticket.priority == 'urgent' %}
                                <span class="badge bg-danger ms-2">긴급</span>
                            {% elif ticket.priority == 'high' %}
                                <span class="badge bg-warning ms-2">높음</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">{{ ticket.created_at.strftime('%Y년 %m월 %d일 %H:%M') }}</small>
                    </div>
                </div>
                <div class="card-body">
                    <p>{{ ticket.message|replace('\n', '<br>')|safe }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 답변 목록 -->
    {% if ticket.replies %}
    <div class="row mb-4">
        <div class="col-12">
            <h5><i class="fas fa-comments me-2"></i>답변 ({{ ticket.replies|length }}개)</h5>
            {% if ticket.get('replies') %}
                        {% for reply in ticket.replies %}
                        <div class="mb-3 p-3 {% if '[관리자 답변]' in reply %}bg-light border-start border-primary border-3{% else %}bg-info bg-opacity-10 border-start border-info border-3{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong>
                                    {% if '[관리자 답변]' in reply %}
                                        <i class="fas fa-shield-alt text-primary me-1"></i>{{ reply.split('(')[0].replace('답변: ', '') }} (관리자)
                                    {% else %}
                                        <i class="fas fa-user text-info me-1"></i>{{ reply.split('(')[0].replace('답변: ', '') }}
                                    {% endif %}
                                </strong>
                                <small class="text-muted">{{ reply.split('(')[1].split(')')[0] if '(' in reply and ')' in reply else '' }}</small>
                            </div>
                            <p class="mb-0">{{ reply.split('\n')[-1] if '\n' in reply else reply }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>아직 답변이 없습니다.
                        </div>
                    {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 답변 작성 (티켓이 종료되지 않은 경우만) -->
    {% if ticket.status != 'closed' %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-reply me-2"></i>답변 작성
                    </h6>
                </div>
                <div class="card-body">
                    <form id="replyForm">
                        <div class="mb-3">
                            <textarea class="form-control" rows="4" placeholder="답변을 입력하세요..." id="replyMessage" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>답변 등록
                        </button>
                        <a href="{{ url_for('customer_support') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>목록으로
                        </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('replyForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const message = document.getElementById('replyMessage').value.trim();
    if (!message) {
        alert('답변 내용을 입력해주세요.');
        return;
    }

    fetch(`/customer-support/{{ ticket.id }}/reply`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('답변 등록 중 오류가 발생했습니다.');
    });
});
</script>
{% endblock %}